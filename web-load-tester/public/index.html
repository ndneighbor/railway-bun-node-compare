<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookstore Load Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .config-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .config-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .config-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .config-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .config-card .stats {
            font-size: 14px;
            color: #666;
        }

        .progress-section {
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .runtime-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .runtime-section.node {
            border-color: #28a745;
        }

        .runtime-section.bun {
            border-color: #fd7e14;
        }

        .runtime-section.winner {
            background: #d4edda;
            border-color: #28a745;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        }

        .runtime-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .runtime-title h3 {
            margin: 0;
            margin-left: 10px;
        }

        .runtime-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .runtime-icon.node {
            background: #28a745;
        }

        .runtime-icon.bun {
            background: #fd7e14;
        }

        .winner-badge {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: auto;
        }

        .comparison-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .comparison-summary h2 {
            margin: 0 0 10px 0;
        }

        .advantage-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .advantage-list li {
            background: #e9ecef;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 14px;
        }

        .advantage-list li.advantage {
            background: #d4edda;
            color: #155724;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-card.error {
            background: #fee;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card.highlight .stat-value,
        .stat-card.highlight .stat-label {
            color: white;
        }

        .stat-card.error .stat-value {
            color: #d00;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Percentile Section */
        .percentile-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .percentile-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .percentile-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .percentile-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .percentile-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .percentile-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        /* Error Types Section */
        .error-types-section {
            margin-top: 20px;
            padding: 15px;
            background: #fee;
            border-radius: 8px;
        }

        .error-types-section h4 {
            margin-bottom: 10px;
            color: #d00;
            font-size: 16px;
        }

        .error-types {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .error-type-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .error-type {
            font-weight: 500;
            color: #666;
        }

        .error-count {
            font-weight: bold;
            color: #d00;
        }

        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .results-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .results-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .error-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .error-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .error-item:last-child {
            border-bottom: none;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .connection-status.connected {
            background: #28a745;
        }

        .connection-status.disconnected {
            background: #dc3545;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Visualization Styles */
        .stats-summary {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .summary-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-item .winner {
            font-weight: 500;
            color: #4a5568;
        }

        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-color.node {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .legend-color.bun {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .error-list.success {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .error-list.success h4 {
            color: #166534;
        }

        .no-errors {
            text-align: center;
            padding: 20px;
            color: #166534;
            font-weight: 500;
        }

        .error-summary {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            text-align: center;
        }

        .reliability-score {
            margin-top: 20px;
            text-align: center;
        }

        .score-comparison {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 10px;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .score {
            font-size: 24px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 8px;
        }

        .score.excellent {
            background: #f0fdf4;
            color: #166534;
        }

        .score.good {
            background: #fef3c7;
            color: #92400e;
        }

        .score.poor {
            background: #fee;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>
    
    <div class="container">
        <div class="header">
            <h1>‚ö° Node.js vs Bun Performance Battle</h1>
            <p>Side-by-side load testing and comparison</p>
        </div>

        <!-- Configuration Section -->
        <div class="card" id="configSection">
            <h2>Load Test Configuration</h2>
            
            <div class="form-group">
                <label for="nodeUrl">Node.js Implementation URL:</label>
                <input type="url" id="nodeUrl" placeholder="Will auto-fill from NODE_PUBLIC_DOMAIN if available" required>
            </div>

            <div class="form-group">
                <label for="bunUrl">Bun Implementation URL:</label>
                <input type="url" id="bunUrl" placeholder="Will auto-fill from BUN_PUBLIC_DOMAIN if available" required>
            </div>

            <div class="form-group">
                <label>Select Test Configuration:</label>
                <div class="config-grid" id="configGrid">
                    <!-- Configurations will be loaded here -->
                </div>
            </div>

            <div class="form-group">
                <button class="btn" id="startTestBtn">ü•ä Start Performance Battle</button>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="card progress-section" id="progressSection">
            <h2>Battle in Progress</h2>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="comparison-summary" id="liveWinner">
                <h2 id="currentWinnerText">ü•ä Battle Starting...</h2>
                <p id="currentWinnerDesc">Warming up both runtimes...</p>
            </div>
            
            <div class="comparison-grid">
                <div class="runtime-section node">
                    <div class="runtime-title">
                        <div class="runtime-icon node">N</div>
                        <h3>Node.js</h3>
                        <div class="winner-badge" id="nodeWinnerBadge" style="display: none;">WINNING</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="nodeRequests">0</div>
                            <div class="stat-label">Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="nodeResponses">0</div>
                            <div class="stat-label">Responses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="nodeAvgTime">0ms</div>
                            <div class="stat-label">Avg Response</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="nodeRps">0</div>
                            <div class="stat-label">RPS</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="nodeErrors">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="nodeErrorRate">0%</div>
                            <div class="stat-label">Error Rate</div>
                        </div>
                    </div>
                </div>

                <div class="runtime-section bun">
                    <div class="runtime-title">
                        <div class="runtime-icon bun">B</div>
                        <h3>Bun</h3>
                        <div class="winner-badge" id="bunWinnerBadge" style="display: none;">WINNING</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="bunRequests">0</div>
                            <div class="stat-label">Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bunResponses">0</div>
                            <div class="stat-label">Responses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bunAvgTime">0ms</div>
                            <div class="stat-label">Avg Response</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bunRps">0</div>
                            <div class="stat-label">RPS</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bunErrors">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bunErrorRate">0%</div>
                            <div class="stat-label">Error Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <button class="btn btn-danger" id="stopTestBtn">Stop Battle</button>
            </div>

            <div class="form-group">
                <h3>Battle Log</h3>
                <div class="log" id="liveLog"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card results-section" id="resultsSection">
            <h2>üèÜ Battle Results</h2>
            
            <div class="comparison-summary" id="finalWinner">
                <h2 id="finalWinnerText">üéâ Results Loading...</h2>
                <p id="finalWinnerDesc">Calculating final scores...</p>
                <div id="advantagesList"></div>
            </div>

            <div class="comparison-grid">
                <div class="runtime-section node" id="nodeFinalSection">
                    <div class="runtime-title">
                        <div class="runtime-icon node">N</div>
                        <h3>Node.js Final Stats</h3>
                        <div class="winner-badge" id="nodeFinalBadge" style="display: none;">WINNER</div>
                    </div>
                    <div id="nodeResults"></div>
                </div>

                <div class="runtime-section bun" id="bunFinalSection">
                    <div class="runtime-title">
                        <div class="runtime-icon bun">B</div>
                        <h3>Bun Final Stats</h3>
                        <div class="winner-badge" id="bunFinalBadge" style="display: none;">WINNER</div>
                    </div>
                    <div id="bunResults"></div>
                </div>
            </div>

            <div class="results-grid">
                <div class="results-card">
                    <h3>Performance Gap Analysis</h3>
                    <div id="performanceGap"></div>
                </div>
                
                <div class="results-card">
                    <h3>Response Time Comparison</h3>
                    <div id="responseTimeComparison"></div>
                </div>
                
                <div class="results-card">
                    <h3>Error Analysis</h3>
                    <div id="errorComparison"></div>
                </div>
            </div>

            <div class="form-group">
                <button class="btn" id="exportResultsBtn">Export Battle Results</button>
                <button class="btn" id="newTestBtn">Start New Battle</button>
            </div>
        </div>
    </div>

    <script>
        class LoadTester {
            constructor() {
                this.ws = null;
                this.currentSessionId = null;
                this.selectedConfig = null;
                this.configurations = {};
                
                this.initializeWebSocket();
                this.loadConfigurations();
                this.loadEnvironmentUrls();
                this.bindEvents();
            }

            initializeWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.updateConnectionStatus(true);
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    this.updateConnectionStatus(false);
                    
                    // Attempt to reconnect after 3 seconds
                    setTimeout(() => this.initializeWebSocket(), 3000);
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
            }

            updateConnectionStatus(connected) {
                const status = document.getElementById('connectionStatus');
                status.textContent = connected ? 'Connected' : 'Disconnected';
                status.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            }

            async loadConfigurations() {
                try {
                    const response = await fetch('/api/configurations');
                    this.configurations = await response.json();
                    this.renderConfigurations();
                } catch (error) {
                    console.error('Failed to load configurations:', error);
                }
            }

            async loadEnvironmentUrls() {
                try {
                    const response = await fetch('/api/environment');
                    const env = await response.json();
                    
                    // Auto-populate URL fields if environment variables are available
                    if (env.hasNodeUrl) {
                        const nodeUrlField = document.getElementById('nodeUrl');
                        nodeUrlField.value = env.nodeUrl;
                        nodeUrlField.style.borderColor = '#28a745'; // Green border to indicate auto-filled
                        
                        // Add a small indicator
                        const indicator = document.createElement('small');
                        indicator.style.color = '#28a745';
                        indicator.style.display = 'block';
                        indicator.textContent = '‚úÖ Auto-filled from NODE_PUBLIC_DOMAIN';
                        nodeUrlField.parentNode.appendChild(indicator);
                    }
                    
                    if (env.hasBunUrl) {
                        const bunUrlField = document.getElementById('bunUrl');
                        bunUrlField.value = env.bunUrl;
                        bunUrlField.style.borderColor = '#fd7e14'; // Orange border to indicate auto-filled
                        
                        // Add a small indicator
                        const indicator = document.createElement('small');
                        indicator.style.color = '#fd7e14';
                        indicator.style.display = 'block';
                        indicator.textContent = '‚úÖ Auto-filled from BUN_PUBLIC_DOMAIN';
                        bunUrlField.parentNode.appendChild(indicator);
                    }
                    
                    // If both URLs are available, show a success message
                    if (env.hasNodeUrl && env.hasBunUrl) {
                        const configSection = document.getElementById('configSection');
                        const successMessage = document.createElement('div');
                        successMessage.style.cssText = `
                            background: #d4edda;
                            border: 1px solid #c3e6cb;
                            color: #155724;
                            padding: 10px;
                            border-radius: 5px;
                            margin-bottom: 15px;
                            font-size: 14px;
                        `;
                        successMessage.innerHTML = 'üéâ URLs auto-detected from environment variables! Ready to battle.';
                        configSection.insertBefore(successMessage, configSection.firstChild);
                    }
                    
                } catch (error) {
                    console.error('Failed to load environment URLs:', error);
                }
            }

            renderConfigurations() {
                const grid = document.getElementById('configGrid');
                grid.innerHTML = '';

                Object.entries(this.configurations).forEach(([key, config]) => {
                    const card = document.createElement('div');
                    card.className = 'config-card';
                    card.dataset.config = key;
                    
                    card.innerHTML = `
                        <h3>${config.name}</h3>
                        <div class="stats">
                            <div>${config.users} users</div>
                            <div>${config.duration}s duration</div>
                            <div>${config.endpoints.length} endpoints</div>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => this.selectConfiguration(key, card));
                    grid.appendChild(card);
                });

                // Select first configuration by default
                if (Object.keys(this.configurations).length > 0) {
                    const firstKey = Object.keys(this.configurations)[0];
                    const firstCard = grid.querySelector(`[data-config="${firstKey}"]`);
                    this.selectConfiguration(firstKey, firstCard);
                }
            }

            selectConfiguration(key, cardElement) {
                // Remove previous selection
                document.querySelectorAll('.config-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Select new configuration
                cardElement.classList.add('selected');
                this.selectedConfig = key;
            }

            bindEvents() {
                document.getElementById('startTestBtn').addEventListener('click', () => this.startTest());
                document.getElementById('stopTestBtn').addEventListener('click', () => this.stopTest());
                document.getElementById('exportResultsBtn').addEventListener('click', () => this.exportResults());
                document.getElementById('newTestBtn').addEventListener('click', () => this.startNewTest());
            }

            async startTest() {
                const nodeUrl = document.getElementById('nodeUrl').value.trim();
                const bunUrl = document.getElementById('bunUrl').value.trim();
                
                if (!nodeUrl || !bunUrl) {
                    alert('Please enter both Node.js and Bun URLs');
                    return;
                }
                
                if (!this.selectedConfig) {
                    alert('Please select a test configuration');
                    return;
                }

                try {
                    const response = await fetch('/api/test/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nodeUrl: nodeUrl,
                            bunUrl: bunUrl,
                            configName: this.selectedConfig
                        })
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        this.currentSessionId = result.sessionId;
                        this.showProgressSection();
                        this.logMessage(`ü•ä Battle started: ${result.sessionId}`);
                        this.logMessage(`Node.js: ${nodeUrl}`);
                        this.logMessage(`Bun: ${bunUrl}`);
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Failed to start test:', error);
                    alert('Failed to start battle');
                }
            }

            async stopTest() {
                if (!this.currentSessionId) return;

                try {
                    const response = await fetch(`/api/test/stop/${this.currentSessionId}`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        this.logMessage('Test stopped by user');
                    }
                } catch (error) {
                    console.error('Failed to stop test:', error);
                }
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'progress':
                        this.updateProgress(data);
                        break;
                    case 'completed':
                        this.showResults(data);
                        break;
                    case 'sessionStopped':
                        this.showResults(data);
                        break;
                    case 'ohaTestStart':
                        this.logOhaMessage(data.runtime, data.message, 'start');
                        break;
                    case 'ohaProgress':
                        this.logOhaMessage(data.runtime, data.message, 'progress');
                        this.updateOhaStats(data.runtime, data.stats);
                        break;
                    case 'ohaCompleted':
                        this.logOhaMessage(data.runtime, data.message, 'completed');
                        break;
                    case 'ohaError':
                        this.logOhaMessage(data.runtime, data.message, 'error');
                        break;
                    case 'ohaRawOutput':
                        this.logOhaMessage(data.runtime, data.rawOutput, 'raw');
                        break;
                }
            }

            logOhaMessage(runtime, message, type) {
                const log = document.getElementById('liveLog');
                const timestamp = new Date().toLocaleTimeString();
                const runtimeLabel = runtime === 'node' ? 'üü¢ Node.js' : 'üü† Bun';
                const typeIcon = {
                    start: 'üöÄ',
                    progress: '‚ö°',
                    completed: '‚úÖ',
                    error: '‚ùå',
                    raw: 'üìü'
                }[type] || 'üìä';
                
                log.innerHTML += `[${timestamp}] ${typeIcon} ${runtimeLabel}: ${message}\n`;
                log.scrollTop = log.scrollHeight;
            }

            updateOhaStats(runtime, stats) {
                // Real-time stats update from oha output
                if (runtime === 'node') {
                    document.getElementById('nodeRequests').textContent = stats.requests.toLocaleString();
                    document.getElementById('nodeResponses').textContent = stats.responses.toLocaleString();
                    document.getElementById('nodeErrors').textContent = stats.errors.toLocaleString();
                    document.getElementById('nodeAvgTime').textContent = `${Math.round(stats.avgResponseTime)}ms`;
                    document.getElementById('nodeRps').textContent = stats.requestsPerSecond.toFixed(1);
                    
                    const errorRate = ((stats.errors / Math.max(stats.requests, 1)) * 100).toFixed(2);
                    document.getElementById('nodeErrorRate').textContent = `${errorRate}%`;
                } else if (runtime === 'bun') {
                    document.getElementById('bunRequests').textContent = stats.requests.toLocaleString();
                    document.getElementById('bunResponses').textContent = stats.responses.toLocaleString();
                    document.getElementById('bunErrors').textContent = stats.errors.toLocaleString();
                    document.getElementById('bunAvgTime').textContent = `${Math.round(stats.avgResponseTime)}ms`;
                    document.getElementById('bunRps').textContent = stats.requestsPerSecond.toFixed(1);
                    
                    const errorRate = ((stats.errors / Math.max(stats.requests, 1)) * 100).toFixed(2);
                    document.getElementById('bunErrorRate').textContent = `${errorRate}%`;
                }
            }

            updateProgress(data) {
                const { progress, comparison } = data;
                
                // Update progress bar
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Update Node.js stats
                const node = comparison.node;
                document.getElementById('nodeRequests').textContent = node.requests.toLocaleString();
                document.getElementById('nodeResponses').textContent = node.responses.toLocaleString();
                document.getElementById('nodeErrors').textContent = node.errors.toLocaleString();
                document.getElementById('nodeAvgTime').textContent = `${node.avgResponseTime}ms`;
                document.getElementById('nodeErrorRate').textContent = `${node.errorRate}%`;
                document.getElementById('nodeRps').textContent = node.rps.toFixed(1);
                
                // Update Bun stats
                const bun = comparison.bun;
                document.getElementById('bunRequests').textContent = bun.requests.toLocaleString();
                document.getElementById('bunResponses').textContent = bun.responses.toLocaleString();
                document.getElementById('bunErrors').textContent = bun.errors.toLocaleString();
                document.getElementById('bunAvgTime').textContent = `${bun.avgResponseTime}ms`;
                document.getElementById('bunErrorRate').textContent = `${bun.errorRate}%`;
                document.getElementById('bunRps').textContent = bun.rps.toFixed(1);
                
                // Update winner display
                const nodeSection = document.querySelector('.runtime-section.node');
                const bunSection = document.querySelector('.runtime-section.bun');
                const nodeBadge = document.getElementById('nodeWinnerBadge');
                const bunBadge = document.getElementById('bunWinnerBadge');
                
                // Reset winner styling
                nodeSection.classList.remove('winner');
                bunSection.classList.remove('winner');
                nodeBadge.style.display = 'none';
                bunBadge.style.display = 'none';
                
                // Update current winner
                let winnerText = 'ü§ù It\'s a tie!';
                let winnerDesc = 'Both runtimes performing equally';
                
                if (comparison.winner === 'node') {
                    nodeSection.classList.add('winner');
                    nodeBadge.style.display = 'block';
                    winnerText = 'üü¢ Node.js is winning!';
                    winnerDesc = `Faster response time: ${node.avgResponseTime}ms vs ${bun.avgResponseTime}ms`;
                } else if (comparison.winner === 'bun') {
                    bunSection.classList.add('winner');
                    bunBadge.style.display = 'block';
                    winnerText = 'üü† Bun is winning!';
                    winnerDesc = `Faster response time: ${bun.avgResponseTime}ms vs ${node.avgResponseTime}ms`;
                }
                
                document.getElementById('currentWinnerText').textContent = winnerText;
                document.getElementById('currentWinnerDesc').textContent = winnerDesc;
                
                // Log progress
                this.logMessage(`Progress: ${progress.toFixed(1)}% | Node: ${node.rps.toFixed(1)} RPS, ${node.avgResponseTime}ms | Bun: ${bun.rps.toFixed(1)} RPS, ${bun.avgResponseTime}ms | Winner: ${comparison.winner.toUpperCase()}`);
            }

            showResults(data) {
                const { session, comparison, stats } = data;
                
                // Hide progress, show results
                document.getElementById('progressSection').classList.remove('active');
                document.getElementById('resultsSection').classList.add('active');
                
                // Final winner display
                let winnerEmoji = 'ü§ù';
                let winnerText = 'It\'s a tie!';
                let winnerDesc = 'Both runtimes performed equally well';
                
                if (comparison.winner === 'node') {
                    winnerEmoji = 'üèÜ';
                    winnerText = 'Node.js Wins!';
                    winnerDesc = `Node.js outperformed Bun in ${comparison.nodeAdvantages.length} key metrics`;
                    document.getElementById('nodeFinalSection').classList.add('winner');
                    document.getElementById('nodeFinalBadge').style.display = 'block';
                } else if (comparison.winner === 'bun') {
                    winnerEmoji = 'üèÜ';
                    winnerText = 'Bun Wins!';
                    winnerDesc = `Bun outperformed Node.js in ${comparison.bunAdvantages.length} key metrics`;
                    document.getElementById('bunFinalSection').classList.add('winner');
                    document.getElementById('bunFinalBadge').style.display = 'block';
                }
                
                document.getElementById('finalWinnerText').textContent = `${winnerEmoji} ${winnerText}`;
                document.getElementById('finalWinnerDesc').textContent = winnerDesc;
                
                // Advantages list
                const advantagesList = document.getElementById('advantagesList');
                let advantagesHtml = '';
                
                if (comparison.nodeAdvantages.length > 0) {
                    advantagesHtml += '<h4>Node.js Advantages:</h4><ul class="advantage-list">';
                    comparison.nodeAdvantages.forEach(advantage => {
                        const label = this.getAdvantageLabel(advantage);
                        advantagesHtml += `<li class="advantage">${label}</li>`;
                    });
                    advantagesHtml += '</ul>';
                }
                
                if (comparison.bunAdvantages.length > 0) {
                    advantagesHtml += '<h4>Bun Advantages:</h4><ul class="advantage-list">';
                    comparison.bunAdvantages.forEach(advantage => {
                        const label = this.getAdvantageLabel(advantage);
                        advantagesHtml += `<li class="advantage">${label}</li>`;
                    });
                    advantagesHtml += '</ul>';
                }
                
                advantagesList.innerHTML = advantagesHtml;
                
                // Node.js results
                const nodeResults = document.getElementById('nodeResults');
                nodeResults.innerHTML = this.formatRuntimeResults(stats.node);
                
                // Bun results
                const bunResults = document.getElementById('bunResults');
                bunResults.innerHTML = this.formatRuntimeResults(stats.bun);
                
                // Performance gap analysis with visual chart
                const performanceGap = document.getElementById('performanceGap');
                this.renderPerformanceGapChart(performanceGap, comparison.performanceGap, stats);
                
                // Response time comparison with visual chart
                const responseTimeComparison = document.getElementById('responseTimeComparison');
                this.renderResponseTimeChart(responseTimeComparison, stats);
                
                // Error analysis with breakdown
                const errorComparison = document.getElementById('errorComparison');
                this.renderErrorAnalysis(errorComparison, stats);
                
                this.logMessage(`üèÅ Battle completed! Winner: ${comparison.winner.toUpperCase()}`);
            }

            getAdvantageLabel(advantage) {
                const labels = {
                    'faster_response_time': '‚ö° Faster Response Time',
                    'higher_throughput': 'üöÄ Higher Throughput',
                    'lower_error_rate': 'üõ°Ô∏è Lower Error Rate',
                    'better_p95_latency': 'üìä Better P95 Latency'
                };
                return labels[advantage] || advantage;
            }

            formatRuntimeResults(stats) {
                // Handle the actual data structure from the server
                const totalRequests = stats.requests || stats.totalRequests || 0;
                const avgResponseTime = Math.round(stats.avgResponseTime || 0);
                const rps = stats.requestsPerSecond ? Math.round(stats.requestsPerSecond * 100) / 100 : (stats.rps || 0);
                const errorRate = stats.errors ? ((stats.errors / Math.max(totalRequests, 1)) * 100).toFixed(2) : (stats.errorRate || 0);
                
                // Get percentiles with fallback
                const percentiles = stats.percentiles || {};
                const p50 = Math.round(percentiles.p50 || avgResponseTime);
                const p95 = Math.round(percentiles.p95 || avgResponseTime * 1.5);
                const p99 = Math.round(percentiles.p99 || avgResponseTime * 2);
                
                return `
                    <div class="stats-grid">
                        <div class="stat-card highlight">
                            <div class="stat-value">${totalRequests.toLocaleString()}</div>
                            <div class="stat-label">Total Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.responses?.toLocaleString() || totalRequests.toLocaleString()}</div>
                            <div class="stat-label">Successful</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${avgResponseTime}ms</div>
                            <div class="stat-label">Avg Response</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${rps}</div>
                            <div class="stat-label">Requests/Sec</div>
                        </div>
                        <div class="stat-card ${errorRate > 5 ? 'error' : ''}">
                            <div class="stat-value">${errorRate}%</div>
                            <div class="stat-label">Error Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.errors || 0}</div>
                            <div class="stat-label">Total Errors</div>
                        </div>
                    </div>
                    <div class="percentile-section">
                        <h4>Response Time Percentiles</h4>
                        <div class="percentile-grid">
                            <div class="percentile-item">
                                <span class="percentile-label">P50 (Median)</span>
                                <span class="percentile-value">${p50}ms</span>
                            </div>
                            <div class="percentile-item">
                                <span class="percentile-label">P95</span>
                                <span class="percentile-value">${p95}ms</span>
                            </div>
                            <div class="percentile-item">
                                <span class="percentile-label">P99</span>
                                <span class="percentile-value">${p99}ms</span>
                            </div>
                        </div>
                    </div>
                    ${Object.keys(stats.errorTypes || {}).length > 0 ? `
                        <div class="error-types-section">
                            <h4>Error Breakdown</h4>
                            <div class="error-types">
                                ${Object.entries(stats.errorTypes || {}).map(([type, count]) => `
                                    <div class="error-type-item">
                                        <span class="error-type">${type}</span>
                                        <span class="error-count">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            }

            showProgressSection() {
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('progressSection').classList.add('active');
                
                // Reset progress
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('liveLog').innerHTML = '';
            }

            logMessage(message) {
                const log = document.getElementById('liveLog');
                const timestamp = new Date().toLocaleTimeString();
                log.innerHTML += `[${timestamp}] ${message}\n`;
                log.scrollTop = log.scrollHeight;
            }

            async exportResults() {
                if (!this.currentSessionId) {
                    alert('No test results to export');
                    return;
                }

                try {
                    // Fetch complete session data
                    const response = await fetch(`/api/test/results/${this.currentSessionId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch results');
                    }
                    
                    const sessionData = await response.json();
                    
                    // Create comprehensive export data
                    const exportData = {
                        sessionId: this.currentSessionId,
                        timestamp: new Date().toISOString(),
                        testConfiguration: sessionData.config,
                        urls: {
                            node: sessionData.nodeUrl,
                            bun: sessionData.bunUrl
                        },
                        results: {
                            winner: sessionData.comparison?.winner || 'unknown',
                            summary: {
                                node: {
                                    totalRequests: sessionData.results.node.requests,
                                    successfulResponses: sessionData.results.node.responses,
                                    totalErrors: sessionData.results.node.errors,
                                    errorRate: ((sessionData.results.node.errors / Math.max(sessionData.results.node.requests, 1)) * 100).toFixed(2) + '%',
                                    avgResponseTime: Math.round(sessionData.results.node.avgResponseTime) + 'ms',
                                    requestsPerSecond: sessionData.results.node.requestsPerSecond,
                                    percentiles: sessionData.results.node.percentiles
                                },
                                bun: {
                                    totalRequests: sessionData.results.bun.requests,
                                    successfulResponses: sessionData.results.bun.responses,
                                    totalErrors: sessionData.results.bun.errors,
                                    errorRate: ((sessionData.results.bun.errors / Math.max(sessionData.results.bun.requests, 1)) * 100).toFixed(2) + '%',
                                    avgResponseTime: Math.round(sessionData.results.bun.avgResponseTime) + 'ms',
                                    requestsPerSecond: sessionData.results.bun.requestsPerSecond,
                                    percentiles: sessionData.results.bun.percentiles
                                }
                            },
                            performanceGaps: sessionData.comparison?.performanceGap,
                            advantages: {
                                node: sessionData.comparison?.nodeAdvantages || [],
                                bun: sessionData.comparison?.bunAdvantages || []
                            },
                            errorBreakdown: {
                                node: sessionData.results.node.errorTypes || {},
                                bun: sessionData.results.bun.errorTypes || {}
                            }
                        },
                        duration: {
                            startTime: sessionData.startTime,
                            endTime: sessionData.endTime,
                            totalSeconds: sessionData.config.duration
                        }
                    };
                    
                    // Create and download the file
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `battle-results-${this.currentSessionId}-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    this.logMessage('üì• Battle results exported successfully');
                } catch (error) {
                    console.error('Export failed:', error);
                    alert('Failed to export results');
                }
            }

            startNewTest() {
                // Reset UI
                document.getElementById('configSection').style.display = 'block';
                document.getElementById('progressSection').classList.remove('active');
                document.getElementById('resultsSection').classList.remove('active');
                
                this.currentSessionId = null;
            }

            renderPerformanceGapChart(container, gaps, stats) {
                const nodeAvgTime = Math.round(stats.node.avgResponseTime || 0);
                const bunAvgTime = Math.round(stats.bun.avgResponseTime || 0);
                const nodeRps = Math.round((stats.node.requestsPerSecond || 0) * 100) / 100;
                const bunRps = Math.round((stats.bun.requestsPerSecond || 0) * 100) / 100;
                
                container.innerHTML = `
                    <div class="chart-container">
                        <h3>Performance Gap Analysis</h3>
                        <div class="bar-chart">
                            <div class="bar-group">
                                <div class="bar node" style="height: ${(nodeRps / Math.max(nodeRps, bunRps)) * 100}%">
                                    <div class="bar-value">${nodeRps}</div>
                                </div>
                                <div class="bar-label">Node.js RPS</div>
                            </div>
                            <div class="bar-group">
                                <div class="bar bun" style="height: ${(bunRps / Math.max(nodeRps, bunRps)) * 100}%">
                                    <div class="bar-value">${bunRps}</div>
                                </div>
                                <div class="bar-label">Bun RPS</div>
                            </div>
                        </div>
                        <div class="stats-summary">
                            <div class="summary-item">
                                <strong>Response Time Gap:</strong> ${gaps.responseTime.toFixed(0)}ms 
                                <span class="winner">(${nodeAvgTime < bunAvgTime ? 'üü¢ Node.js' : 'üü† Bun'} faster)</span>
                            </div>
                            <div class="summary-item">
                                <strong>Throughput Gap:</strong> ${gaps.throughput.toFixed(1)} RPS 
                                <span class="winner">(${nodeRps > bunRps ? 'üü¢ Node.js' : 'üü† Bun'} higher)</span>
                            </div>
                            <div class="summary-item">
                                <strong>Error Rate Gap:</strong> ${gaps.errorRate.toFixed(2)}% 
                                <span class="winner">(${stats.node.errors < stats.bun.errors ? 'üü¢ Node.js' : 'üü† Bun'} more reliable)</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderResponseTimeChart(container, stats) {
                const nodeP50 = Math.round(stats.node.percentiles?.p50 || stats.node.avgResponseTime);
                const nodeP95 = Math.round(stats.node.percentiles?.p95 || stats.node.avgResponseTime * 1.5);
                const nodeP99 = Math.round(stats.node.percentiles?.p99 || stats.node.avgResponseTime * 2);
                
                const bunP50 = Math.round(stats.bun.percentiles?.p50 || stats.bun.avgResponseTime);
                const bunP95 = Math.round(stats.bun.percentiles?.p95 || stats.bun.avgResponseTime * 1.5);
                const bunP99 = Math.round(stats.bun.percentiles?.p99 || stats.bun.avgResponseTime * 2);
                
                const maxLatency = Math.max(nodeP99, bunP99);
                
                container.innerHTML = `
                    <div class="chart-container">
                        <h3>Response Time Comparison</h3>
                        <div class="percentile-chart">
                            <div class="percentile-row">
                                <div class="percentile-label">P50</div>
                                <div class="percentile-bars">
                                    <div class="percentile-bar node" style="width: ${(nodeP50 / maxLatency) * 100}%">${nodeP50}ms</div>
                                    <div class="percentile-bar bun" style="width: ${(bunP50 / maxLatency) * 100}%">${bunP50}ms</div>
                                </div>
                            </div>
                            <div class="percentile-row">
                                <div class="percentile-label">P95</div>
                                <div class="percentile-bars">
                                    <div class="percentile-bar node" style="width: ${(nodeP95 / maxLatency) * 100}%">${nodeP95}ms</div>
                                    <div class="percentile-bar bun" style="width: ${(bunP95 / maxLatency) * 100}%">${bunP95}ms</div>
                                </div>
                            </div>
                            <div class="percentile-row">
                                <div class="percentile-label">P99</div>
                                <div class="percentile-bars">
                                    <div class="percentile-bar node" style="width: ${(nodeP99 / maxLatency) * 100}%">${nodeP99}ms</div>
                                    <div class="percentile-bar bun" style="width: ${(bunP99 / maxLatency) * 100}%">${bunP99}ms</div>
                                </div>
                            </div>
                        </div>
                        <div class="legend">
                            <span class="legend-item"><span class="legend-color node"></span> Node.js</span>
                            <span class="legend-item"><span class="legend-color bun"></span> Bun</span>
                        </div>
                    </div>
                `;
            }

            renderErrorAnalysis(container, stats) {
                const nodeErrors = stats.node.errors || 0;
                const bunErrors = stats.bun.errors || 0;
                const nodeErrorRate = ((nodeErrors / Math.max(stats.node.requests || 1, 1)) * 100).toFixed(2);
                const bunErrorRate = ((bunErrors / Math.max(stats.bun.requests || 1, 1)) * 100).toFixed(2);
                
                container.innerHTML = `
                    <div class="chart-container">
                        <h3>Error Analysis</h3>
                        <div class="error-breakdown">
                            <div class="error-list ${nodeErrors > 0 ? '' : 'success'}">
                                <h4>üü¢ Node.js Errors</h4>
                                ${nodeErrors > 0 ? `
                                    <div class="error-summary">
                                        <strong>${nodeErrors} total errors (${nodeErrorRate}%)</strong>
                                    </div>
                                    ${Object.entries(stats.node.errorTypes || {}).map(([type, count]) => `
                                        <div class="error-item">
                                            <span class="error-type">${type}</span>
                                            <span class="error-count">${count}</span>
                                        </div>
                                    `).join('')}
                                ` : '<div class="no-errors">‚úÖ No errors detected!</div>'}
                            </div>
                            <div class="error-list ${bunErrors > 0 ? '' : 'success'}">
                                <h4>üü† Bun Errors</h4>
                                ${bunErrors > 0 ? `
                                    <div class="error-summary">
                                        <strong>${bunErrors} total errors (${bunErrorRate}%)</strong>
                                    </div>
                                    ${Object.entries(stats.bun.errorTypes || {}).map(([type, count]) => `
                                        <div class="error-item">
                                            <span class="error-type">${type}</span>
                                            <span class="error-count">${count}</span>
                                        </div>
                                    `).join('')}
                                ` : '<div class="no-errors">‚úÖ No errors detected!</div>'}
                            </div>
                        </div>
                        <div class="reliability-score">
                            <h4>Reliability Score</h4>
                            <div class="score-comparison">
                                <div class="score-item">
                                    <span class="runtime">Node.js</span>
                                    <span class="score ${nodeErrorRate < 1 ? 'excellent' : nodeErrorRate < 5 ? 'good' : 'poor'}">${(100 - parseFloat(nodeErrorRate)).toFixed(1)}%</span>
                                </div>
                                <div class="score-item">
                                    <span class="runtime">Bun</span>
                                    <span class="score ${bunErrorRate < 1 ? 'excellent' : bunErrorRate < 5 ? 'good' : 'poor'}">${(100 - parseFloat(bunErrorRate)).toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new LoadTester();
        });
    </script>
</body>
</html>
